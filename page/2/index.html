<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.ciel07yxh.top","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="在这里记录我的学习 grit！">
<meta property="og:type" content="website">
<meta property="og:title" content="Ciel&#39;s blog">
<meta property="og:url" content="http://blog.ciel07yxh.top/page/2/index.html">
<meta property="og:site_name" content="Ciel&#39;s blog">
<meta property="og:description" content="在这里记录我的学习 grit！">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="ciel">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://blog.ciel07yxh.top/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Ciel's blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Ciel's blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Hi, this is Ciel!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ciel</p>
  <div class="site-description" itemprop="description">在这里记录我的学习 grit！</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.ciel07yxh.top/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ciel">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ciel's blog">
      <meta itemprop="description" content="在这里记录我的学习 grit！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Ciel's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/" class="post-title-link" itemprop="url">Nginx ingress cert auto-rotation with kv integration</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-27 11:46:08" itemprop="dateCreated datePublished" datetime="2024-01-27T11:46:08+08:00">2024-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-13 21:08:22" itemprop="dateModified" datetime="2025-04-13T21:08:22+08:00">2025-04-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Azure/" itemprop="url" rel="index"><span itemprop="name">Azure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="General-description"><a href="#General-description" class="headerlink" title="General description"></a>General description</h1><ol>
<li><p>为AKS集群使能Azure Key Vault Provider for Secrets Store CSI Driver</p>
<p>参考： <a href="https://nam06.safelinks.protection.outlook.com/?url=https://urldefense.com/v3/__https:/learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver__;!!AoaiBx6H!wU-mET2WEUk12-VB5dToKIfGuKxbe0ZhxVNsdo3jKOaE4cJ5CJTqtqrZEIZDrPbnXzTTKfpXEMlHe6ebak9yNxyO2Q$&data=05%7C01%7Cxiaohanyuan@microsoft.com%7C4d0ef97489644d0c1bb408dbeb421ab4%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638362441425530391%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0=%7C3000%7C%7C%7C&sdata=fKD4DiKMG6Ljp0IuFl+m1v2LpIe4r+x+InIr/OcqI5s=&reserved=0">Use the Azure Key Vault Provider for Secrets Store CSI      Driver for Azure Kubernetes Service (AKS) secrets - Azure Kubernetes      Service | Microsoft Learn</a></p>
</li>
<li><p>配置使用<strong>Microsoft Entra Workload ID</strong>或<strong>user-assigned managed identity</strong>的方式从KV获取资源</p>
<p>参考：<a href="https://nam06.safelinks.protection.outlook.com/?url=https://urldefense.com/v3/__https:/learn.microsoft.com/en-us/azure/aks/csi-secrets-store-identity-access__;!!AoaiBx6H!wU-mET2WEUk12-VB5dToKIfGuKxbe0ZhxVNsdo3jKOaE4cJ5CJTqtqrZEIZDrPbnXzTTKfpXEMlHe6ebak9-AGMmAg$&data=05%7C01%7Cxiaohanyuan@microsoft.com%7C4d0ef97489644d0c1bb408dbeb421ab4%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638362441425541034%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0=%7C3000%7C%7C%7C&sdata=d7WJWUG6vabYrVdY0okM1B2DS0vsmtMVuALzAPFIPrI=&reserved=0">Provide an access identity to the Azure Key Vault Provider for Secrets Store CSI Driver for Azure Kubernetes Service (AKS) secrets - Azure Kubernetes Service |Microsoft Learn</a></p>
</li>
<li><p>部署<strong>SecretProviderClass</strong>资源将KV中证书资源mount，并同步到集群secretObject</p>
<p>参考：<a href="https://nam06.safelinks.protection.outlook.com/?url=https://urldefense.com/v3/__https:/learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver*sync-mounted-content-with-a-kubernetes-secret__;Iw!!AoaiBx6H!wU-mET2WEUk12-VB5dToKIfGuKxbe0ZhxVNsdo3jKOaE4cJ5CJTqtqrZEIZDrPbnXzTTKfpXEMlHe6ebak8KVTCxsw$&data=05%7C01%7Cxiaohanyuan@microsoft.com%7C4d0ef97489644d0c1bb408dbeb421ab4%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638362441425549314%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0=%7C3000%7C%7C%7C&sdata=z9REMcu7iHL9Zdxs0E5KaDSvB6z/Htqgnf1WaB3mojU=&reserved=0">Sync mounted content with a Kubernetes secret</a>，<a href="https://nam06.safelinks.protection.outlook.com/?url=https://urldefense.com/v3/__https:/learn.microsoft.com/en-us/azure/aks/csi-secrets-store-nginx-tls*deploy-a-secretproviderclass__;Iw!!AoaiBx6H!wU-mET2WEUk12-VB5dToKIfGuKxbe0ZhxVNsdo3jKOaE4cJ5CJTqtqrZEIZDrPbnXzTTKfpXEMlHe6ebak98BnNzCQ$&data=05%7C01%7Cxiaohanyuan@microsoft.com%7C4d0ef97489644d0c1bb408dbeb421ab4%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638362441425556585%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0=%7C3000%7C%7C%7C&sdata=ZJ+atyfL3eEZmnSLliNg6B11HbP0FWiQzb8rA2qfHqw=&reserved=0">Deploy a SecretProviderClass</a></p>
</li>
<li><p>配置Nginx Ingress使用secretObject</p>
<p>参考：<a href="https://nam06.safelinks.protection.outlook.com/?url=https://urldefense.com/v3/__https:/learn.microsoft.com/en-us/azure/aks/csi-secrets-store-nginx-tls__;!!AoaiBx6H!wU-mET2WEUk12-VB5dToKIfGuKxbe0ZhxVNsdo3jKOaE4cJ5CJTqtqrZEIZDrPbnXzTTKfpXEMlHe6ebak-JsgNmHw$&data=05%7C01%7Cxiaohanyuan@microsoft.com%7C4d0ef97489644d0c1bb408dbeb421ab4%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638362441425563651%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0=%7C3000%7C%7C%7C&sdata=qEw56V0BZqL2bx502eaqhYP/yo8SBNaCWiDU8d1GG2M=&reserved=0">Set up Secrets Store CSI Driver to enable NGINX Ingress Controller with TLS on Azure Kubernetes Service (AKS) - Azure Kubernetes Service | Microsoft Learn</a></p>
</li>
<li><p>如果需要确保mount到Pod的资源可以自动更新，您需要手动使能autorotation；默认情况下，集群从KV中pull数据的间隔为2min，也可以自定义该时间间隔</p>
<p>参考：<a href="https://nam06.safelinks.protection.outlook.com/?url=https://urldefense.com/v3/__https:/learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver*enable-and-disable-autorotation__;Iw!!AoaiBx6H!wU-mET2WEUk12-VB5dToKIfGuKxbe0ZhxVNsdo3jKOaE4cJ5CJTqtqrZEIZDrPbnXzTTKfpXEMlHe6ebak-PNHMciw$&data=05%7C01%7Cxiaohanyuan@microsoft.com%7C4d0ef97489644d0c1bb408dbeb421ab4%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638362441425570366%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0=%7C3000%7C%7C%7C&sdata=MCpxy7PWnyvlQgE1PzYJ2cPZRndboGuZR2JFRzKMnuQ=&reserved=0">Enable and disable autorotation</a> </p>
</li>
<li><p>另外请注意，上述autorotation的开启只能保证secret的自动更新，应用侧需要主动监测volume等的变化以达到热更新。<strong>【经测试，IngressNginx不需要Reloader也可以自动更新cert】</strong></p>
</li>
</ol>
<h1 id="Detailed-steps"><a href="#Detailed-steps" class="headerlink" title="Detailed steps"></a>Detailed steps</h1><ol>
<li><p><strong>创建好AKS集群以及kv资源</strong></p>
</li>
<li><p><strong>为AKS集群使能Azure Key Vault Provider for Secrets Store CSI Driver</strong></p>
<p>参考： <a href="https://nam06.safelinks.protection.outlook.com/?url=https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver&data=05%7C01%7Cxiaohanyuan@microsoft.com%7Ccaeec7bc72f643645ed608dbd054dad0%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C638332835124071443%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0=%7C3000%7C%7C%7C&sdata=n7xi2ZmymLWXRjWELlzWLS2+KpOJ3CdbmaVCw8wmVsE=&reserved=0">Use the Azure Key Vault Provider for Secrets Store CSI Driver for Azure Kubernetes Service (AKS) secrets - Azure Kubernetes Service | Microsoft Learn</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">enable</span> addon:</span></span><br><span class="line">az aks enable-addons --addons azure-keyvault-secrets-provider --name csiaks --resource-group csiaks</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">verification</span></span><br><span class="line">[ciel@centos ~]$ kubectl get pods -n kube-system -l &#x27;app in (secrets-store-csi-driver,secrets-store-provider-azure)&#x27;</span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">aks-secrets-store-csi-driver-h7dzx       3/3     Running   0          139m</span><br><span class="line">aks-secrets-store-provider-azure-2842p   1/1     Running   0          139m</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置使用Microsoft Entra Workload ID或user-assigned managed identity的方式从KV获取资源，并验证</strong></p>
<p>参考：<a href="https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-identity-access#access-with-a-user-assigned-managed-identity">Access with a user-assigned managed identity</a></p>
<p>a. 可以使用启用addon时候默认创建的managed identity也可以重新创建一个，这里使用现有的<br>Access your key vault using the <a href="https://learn.microsoft.com/en-us/cli/azure/aks#az-aks-show">az aks show</a> command and the user-assigned managed identity created by the add-on when you <a href="https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-driver#create-an-aks-cluster-with-azure-key-vault-provider-for-secrets-store-csi-driver-support">enabled the Azure Key Vault provider for Secrets Store CSI Driver on your AKS Cluster</a>.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ciel@centos ~]$ az aks show -g csiaks -n csiaks --query addonProfiles.azureKeyvaultSecretsProvider.identity.clientId -o tsv</span><br><span class="line">The behavior of this command has been altered by the following extension: aks-preview</span><br></pre></td></tr></table></figure>

<p>b. 给identity授权访问KV （”Key Vault Administrator”  role）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export IDENTITY_CLIENT_ID=&quot;$(az identity show -g MC_csiaks_csiaks_chinanorth2 --name azurekeyvaultsecretsprovider-csiaks --query &#x27;clientId&#x27; -o tsv)&quot;</span><br><span class="line">export KEYVAULT_SCOPE=$(az keyvault show --name csikv --query id -o tsv)</span><br><span class="line">	</span><br><span class="line">az role assignment create --role &quot;Key Vault Administrator&quot; --assignee f007248d-890f-4ba2-943b-8xxxxxxde6 --scope $KEYVAULT_SCOPE![image-20240128001750051](Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128001750051.png)</span><br></pre></td></tr></table></figure>

<img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128001750051.png" width="70%" height="70%">

<p>​    文档中步骤3-5创建了SecretProviderClass和一个busybox的pod，校验获取secret是否能成功 [先在对应的kv中创建secret1和key1]</p>
<p><em>k apply -f secretproviderclass.yml</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a SecretProviderClass example using user-assigned identity to access your key vault</span></span><br><span class="line">apiVersion: secrets-store.csi.x-k8s.io/v1</span><br><span class="line">kind: SecretProviderClass</span><br><span class="line">metadata:</span><br><span class="line">  name: azure-kvname-user-msi</span><br><span class="line">spec:</span><br><span class="line">  provider: azure</span><br><span class="line">  parameters:</span><br><span class="line">    usePodIdentity: &quot;false&quot;</span><br><span class="line">    useVMManagedIdentity: &quot;true&quot;          # Set to true for using managed identity</span><br><span class="line">    userAssignedIdentityID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx   # Set the clientID of the user-assigned managed identity to use</span><br><span class="line">    keyvaultName: csikv        # Set to the name of your key vault</span><br><span class="line">    cloudName: &quot;AzureChinaCloud&quot;                         # [OPTIONAL for Azure] if not provided, the Azure environment defaults to AzurePublicCloud</span><br><span class="line">    objects:  |</span><br><span class="line">      array:</span><br><span class="line">        - |</span><br><span class="line">          objectName: secret1</span><br><span class="line">          objectType: secret              # object types: secret, key, or cert</span><br><span class="line">          objectVersion: &quot;&quot;               # [OPTIONAL] object versions, default to latest if empty</span><br><span class="line">        - |</span><br><span class="line">          objectName: key1</span><br><span class="line">          objectType: key</span><br><span class="line"></span><br><span class="line">          objectVersion: &quot;&quot;</span><br><span class="line">    tenantId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx                 # The tenant ID of the key vault</span><br><span class="line">~</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p><em>k apply -f pod.yml</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a sample pod definition <span class="keyword">for</span> using SecretProviderClass and the user-assigned identity to access your key vault</span></span><br><span class="line">kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox-secrets-store-inline-user-msi</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: busybox</span><br><span class="line">      image: k8sgcr.azk8s.cn/e2e-test-images/busybox:1.29-4</span><br><span class="line">      command:</span><br><span class="line">        - &quot;/bin/sleep&quot;</span><br><span class="line">        - &quot;10000&quot;</span><br><span class="line">      volumeMounts:</span><br><span class="line">      - name: secrets-store01-inline</span><br><span class="line">        mountPath: &quot;/mnt/secrets-store&quot;</span><br><span class="line">        readOnly: true</span><br><span class="line">  volumes:</span><br><span class="line">    - name: secrets-store01-inline</span><br><span class="line">      csi:</span><br><span class="line">        driver: secrets-store.csi.k8s.io</span><br><span class="line">        readOnly: true</span><br><span class="line">        volumeAttributes:</span><br><span class="line">          secretProviderClass: &quot;azure-kvname-user-msi&quot;</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p><em>verification</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec busybox-secrets-store-inline-user-msi -- ls /mnt/secrets-store/</span><br><span class="line">kubectl exec busybox-secrets-store-inline-user-msi -- cat /mnt/secrets-store/secret1</span><br></pre></td></tr></table></figure>

<img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128002745041.png" alt="image-20240128002745041" style="zoom:50%;">
</li>
<li><p><strong>正题：配置Nginx Ingress使用KV中的证书 [文档中有Bind certificate to application以及Bind certificate to ingress controller两种，应该分别对应配置后端应用证书以及Ingress前端证书；此处lab的是在ingress controller配置ingress前端证书]</strong></p>
<p>参考： <a href="https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-nginx-tls">Set up Secrets Store CSI Driver to enable      NGINX Ingress Controller with TLS on Azure Kubernetes Service (AKS) -      Azure Kubernetes Service | Microsoft Learn</a></p>
<p> a. 创建并上传证书</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Generate a TLS certificate</span></span><br><span class="line">export CERT_NAME=aks-ingress-cert</span><br><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 \</span><br><span class="line">-out aks-ingress-tls.crt \</span><br><span class="line">-keyout aks-ingress-tls.key \</span><br><span class="line">-subj &quot;/CN=demo.azure.com/O=aks-ingress-tls&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Import the certificate to AKV</span></span><br><span class="line">export AKV_NAME=&quot;[YOUR AKV NAME]&quot;</span><br><span class="line">openssl pkcs12 -export -in aks-ingress-tls.crt -inkey aks-ingress-tls.key  -out $CERT_NAME.pfx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">skip Password prompt</span></span><br><span class="line">az keyvault certificate import --vault-name $AKV_NAME -n $CERT_NAME -f $CERT_NAME.pfx</span><br></pre></td></tr></table></figure>
<p> b. Deploy a <em>SecretProviderClass</em></p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export NAMESPACE=ingress-basic</span><br><span class="line">kubectl create namespace $NAMESPACE</span><br></pre></td></tr></table></figure>
<p> <em>kubectl apply -f SPC1026.yaml -n $NAMESPACE</em></p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: secrets-store.csi.x-k8s.io/v1</span><br><span class="line">kind: SecretProviderClass</span><br><span class="line">metadata:</span><br><span class="line">  name: azure-tls</span><br><span class="line">spec:</span><br><span class="line">  provider: azure</span><br><span class="line">  secretObjects:                            # secretObjects defines the desired state of synced K8s secret objects</span><br><span class="line">    - secretName: ingress-tls-csi</span><br><span class="line">      type: kubernetes.io/tls</span><br><span class="line">      data: </span><br><span class="line">        - objectName: aks-ingress-cert</span><br><span class="line">          key: tls.key</span><br><span class="line">        - objectName: aks-ingress-cert</span><br><span class="line">          key: tls.crt</span><br><span class="line">  parameters:</span><br><span class="line">    usePodIdentity: &quot;false&quot;</span><br><span class="line">    useVMManagedIdentity: &quot;true&quot;</span><br><span class="line">    userAssignedIdentityID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx  </span><br><span class="line">    keyvaultName: csikv                 # the name of the AKV instance</span><br><span class="line">    cloudName: &quot;AzureChinaCloud&quot; </span><br><span class="line">    objects: |</span><br><span class="line">      array:</span><br><span class="line">        - |</span><br><span class="line">          objectName: aks-ingress-cert</span><br><span class="line">          objectType: secret</span><br><span class="line">    tenantId: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxx                     # the tenant ID of the AKV instance</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
 <img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128003234400.png" alt="image-20240128003234400" style="zoom:67%;"></li>
</ol>
<p>c. Deploy the ingress controller –&gt; check <a href="https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-nginx-tls#bind-certificate-to-ingress-controller">Bind certificate to ingress controller section</a>      </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">helm install my-ingress ingress-nginx/ingress-nginx  --version 4.1.3 \</span><br><span class="line">    --namespace $NAMESPACE \</span><br><span class="line">    --set controller.replicaCount=2 \</span><br><span class="line">    --set controller.nodeSelector.&quot;kubernetes\.io/os&quot;=linux \</span><br><span class="line">    --set defaultBackend.nodeSelector.&quot;kubernetes\.io/os&quot;=linux \</span><br><span class="line">    --set controller.service.annotations.&quot;service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path&quot;=/healthz \</span><br><span class="line">    --set controller.image.repository=k8sgcr.azk8s.cn/ingress-nginx/controller \</span><br><span class="line">    --set defaultBackend.image.repository=k8sgcr.azk8s.cn/defaultbackend-amd64  \</span><br><span class="line">    --set controller.admissionWebhooks.patch.image.registry=k8sgcr.azk8s.cn \</span><br><span class="line">    -f - &lt;&lt;EOF</span><br><span class="line">controller:</span><br><span class="line">  extraVolumes:</span><br><span class="line">      - name: secrets-store-inline</span><br><span class="line">        csi:</span><br><span class="line">          driver: secrets-store.csi.k8s.io</span><br><span class="line">          readOnly: true</span><br><span class="line">          volumeAttributes:</span><br><span class="line">            secretProviderClass: &quot;azure-tls&quot;</span><br><span class="line">  extraVolumeMounts:</span><br><span class="line">      - name: secrets-store-inline</span><br><span class="line">        mountPath: &quot;/mnt/secrets-store&quot;</span><br><span class="line">        readOnly: true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128003403340.png" alt="image-20240128003403340"></p>
<p>Ingress controller Pod 创建好之后就可以在集群里看到Secret啦</p>
<img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128003417852.png" alt="image-20240128003417852" style="zoom:67%;">

<img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128003431160.png" alt="image-20240128003431160" style="zoom:67%;">

<p>d. Deploy the application –&gt; <a href="https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-nginx-tls#deploy-the-application-using-an-ingress-controller-reference">Deploy the application using an ingress controller reference</a> [文档里面yaml格式空格有点儿问题]</p>
<p><em>kubectl apply  - f aks-helloworld-one . yaml  - n $NAMESPACE</em> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: aks-helloworld-one  </span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: aks-helloworld-one</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: aks-helloworld-one</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: aks-helloworld-one</span><br><span class="line">        image: mcr.microsoft.com/azuredocs/aks-helloworld:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        env:</span><br><span class="line">        - name: TITLE</span><br><span class="line">          value: &quot;Welcome to Azure Kubernetes Service (AKS)&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: aks-helloworld-one</span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: aks-helloworld-one</span><br></pre></td></tr></table></figure>

<p><em>kubectl apply  - f aks-helloworld-two . yaml  - n $NAMESPACE</em> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: aks-helloworld-two  </span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: aks-helloworld-two</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: aks-helloworld-two</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: aks-helloworld-two</span><br><span class="line">        image: mcr.microsoft.com/azuredocs/aks-helloworld:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        env:</span><br><span class="line">        - name: TITLE</span><br><span class="line">          value: &quot;AKS Ingress Demo&quot;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: aks-helloworld-two  </span><br><span class="line">spec:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: aks-helloworld-two</span><br></pre></td></tr></table></figure>

<p>e. <a href="https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-nginx-tls#deploy-an-ingress-resource-referencing-the-secret">Deploy an ingress resource referencing the secret</a></p>
<p>*kubectl apply **-<strong>f hello-world-ingress</strong>.**yaml **-*<em>n $NAMESPACE</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-tls</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /$2</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">    - demo.azure.com</span><br><span class="line">    secretName: ingress-tls-csi</span><br><span class="line">  rules:</span><br><span class="line">  - host: demo.azure.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /hello-world-one(/|$)(.*)</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: aks-helloworld-one</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">      - path: /hello-world-two(/|$)(.*)</span><br><span class="line">        pathType: Prefix      </span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: aks-helloworld-two</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line">      - path: /(.*)</span><br><span class="line">        pathType: Prefix      </span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: aks-helloworld-one</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<p><em>verification</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ciel@centos CSI]$ kubectl get service --namespace $NAMESPACE --selector app.kubernetes.io/name=ingress-nginx</span><br><span class="line">NAME                                            TYPE           CLUSTER-IP    EXTERNAL-IP    PORT(S)                      AGE</span><br><span class="line">my-ingress-ingress-nginx-controller             LoadBalancer   10.0.58.216   40.xx.xx.228   80:30141/TCP,443:30810/TCP   4h14m</span><br><span class="line">my-ingress-ingress-nginx-controller-admission   ClusterIP      10.0.74.140   &lt;none&gt;         443/TCP </span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -k --resolve demo.azure.com:443:40.73.33.228 https://demo.azure.com</span><br></pre></td></tr></table></figure>

<img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128003838719.png" alt="image-20240128003838719" style="zoom:50%;">

<ol start="5">
<li><p><strong>如果需要确保mount到Pod的资源可以自动更新，需要手动使能autorotation；默认情况下，集群从KV中pull数据的间隔为2min，也可以自定义该时间间隔</strong></p>
<p>参考：<a href="https://learn.microsoft.com/en-us/azure/aks/csi-secrets-store-configuration-options#enable-and-disable-auto-rotation">Enable and disable autorotation</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az aks addon update  -n csiaks -g csiaks -a azure-keyvault-secrets-provider --enable-secret-rotation</span><br></pre></td></tr></table></figure>

<img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128003944426.png" alt="image-20240128003944426" style="zoom:50%;">

<img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128003956429.png" alt="image-20240128003956429" style="zoom:50%;">
</li>
<li><p><strong>另外请注意，上述autorotation的开启只能保证secret的自动更新，应用侧需要主动监测volume等的变化以达到热更新。</strong><br>  <u><strong>[经测试，Ingress Nginx不需要Reloader也可以自动更新cert]</strong></u></p>
<p><img src="/2024/01/27/Azure/Nginx-ingress-cert-auto-rotation-with-kv-integration/image-20240128004638863.png" alt="image-20240128004638863"></p>
</li>
</ol>
<p>​		</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.ciel07yxh.top/2020/12/10/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E9%9D%A2%E8%AF%95%E9%A2%9821-%E5%8C%85%E5%90%ABmin%E5%87%BD%E6%95%B0%E7%9A%84%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ciel">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ciel's blog">
      <meta itemprop="description" content="在这里记录我的学习 grit！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Ciel's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/12/10/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E9%9D%A2%E8%AF%95%E9%A2%9821-%E5%8C%85%E5%90%ABmin%E5%87%BD%E6%95%B0%E7%9A%84%E6%A0%88/" class="post-title-link" itemprop="url">面试题21-包含min函数的栈</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-10 20:08:17" itemprop="dateCreated datePublished" datetime="2020-12-10T20:08:17+08:00">2020-12-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-13 21:08:23" itemprop="dateModified" datetime="2025-04-13T21:08:23+08:00">2025-04-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">数据结构与算法</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>定义栈的数据结构，请在该类型中实现一个能够得到栈的最小元素的 min 函数在该栈中，调用 min、push 及 pop 的时间复杂度都是 O(1)。</p>
<p>示例:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MinStack minStack = new MinStack();</span><br><span class="line">minStack.push(-2);</span><br><span class="line">minStack.push(0);</span><br><span class="line">minStack.push(-3);</span><br><span class="line">minStack.min();   --&gt; 返回 -3.</span><br><span class="line">minStack.pop();</span><br><span class="line">minStack.top();      --&gt; 返回 0.</span><br><span class="line">minStack.min();   --&gt; 返回 -2.</span><br></pre></td></tr></table></figure>



<h2 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h2><h3 id="My-first-commit"><a href="#My-first-commit" class="headerlink" title="My first commit"></a>My first commit</h3><blockquote>
<p>没有降低min的复杂度, 遍历一次时间复杂度为O(N)</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MinStack</span>:</span><br><span class="line">    stack = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        initialize your data structure here.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.stack = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, x: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.stack.append(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        top_item = <span class="variable language_">self</span>.stack[-<span class="number">1</span>]</span><br><span class="line">        <span class="variable language_">self</span>.stack = <span class="variable language_">self</span>.stack[:-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> top_item</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">top</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        top = <span class="variable language_">self</span>.stack[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> top</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">min</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="comment"># stack_items = self.stack</span></span><br><span class="line">        minimun = <span class="variable language_">self</span>.stack[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> cnt <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(<span class="variable language_">self</span>.stack)-<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.stack[cnt+<span class="number">1</span>] &lt;= minimun:</span><br><span class="line">                minimun = <span class="variable language_">self</span>.stack[cnt+<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> minimun</span><br><span class="line"></span><br><span class="line"><span class="comment"># Your MinStack object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"># obj = MinStack()</span></span><br><span class="line"><span class="comment"># obj.push(x)</span></span><br><span class="line"><span class="comment"># obj.pop()</span></span><br><span class="line"><span class="comment"># param_3 = obj.top()</span></span><br><span class="line"><span class="comment"># param_4 = obj.min()</span></span><br></pre></td></tr></table></figure>



<h3 id="Takeaway-from-others"><a href="#Takeaway-from-others" class="headerlink" title="Takeaway from others"></a>Takeaway from others</h3><blockquote>
<p><a href="https://leetcode-cn.com/problems/bao-han-minhan-shu-de-zhan-lcof/solution/mian-shi-ti-30-bao-han-minhan-shu-de-zhan-fu-zhu-z/">面试题30. 包含 min 函数的栈（辅助栈，清晰图解）</a></p>
<p><img src="/2020/12/10/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E9%9D%A2%E8%AF%95%E9%A2%9821-%E5%8C%85%E5%90%ABmin%E5%87%BD%E6%95%B0%E7%9A%84%E6%A0%88/f31f4b7f5e91d46ea610b6685c593e12bf798a9b8336b0560b6b520956dd5272-Picture1.png" alt="Picture1.png"></p>
<ul>
<li>利用辅助栈来降低复杂度</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MinStack</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.A, <span class="variable language_">self</span>.B = [], []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, x: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.A.append(x)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.B <span class="keyword">or</span> <span class="variable language_">self</span>.B[-<span class="number">1</span>] &gt;= x:</span><br><span class="line">            <span class="variable language_">self</span>.B.append(x)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.A.pop() == <span class="variable language_">self</span>.B[-<span class="number">1</span>]:</span><br><span class="line">            <span class="variable language_">self</span>.B.pop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">top</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.A[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">min</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.B[-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><p>python 中 slice:</p>
<blockquote>
<p><a href="https://stackoverflow.com/questions/509211/understanding-slice-notation">Understanding slice notation</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[start:stop:step]</span><br></pre></td></tr></table></figure>

<p>is equivalent to:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[<span class="built_in">slice</span>(start, stop, step)]</span><br></pre></td></tr></table></figure>
</li>
<li><p>常犯错误: 循环中不能改变循环变量!</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://blog.ciel07yxh.top/2020/11/30/English/TED-How-to-be-fearless-in-the-face-of-authoritarianism/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ciel">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ciel's blog">
      <meta itemprop="description" content="在这里记录我的学习 grit！">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Ciel's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/11/30/English/TED-How-to-be-fearless-in-the-face-of-authoritarianism/" class="post-title-link" itemprop="url">TED - How to be fearless in the face of authoritarianism</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-11-30 10:13:32" itemprop="dateCreated datePublished" datetime="2020-11-30T10:13:32+08:00">2020-11-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-13 21:08:23" itemprop="dateModified" datetime="2025-04-13T21:08:23+08:00">2025-04-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/English/" itemprop="url" rel="index"><span itemprop="name">English</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><blockquote>
<p>难点：口音</p>
</blockquote>
<div style="max-width:854px"><div style="position:relative;height:0;padding-bottom:56.25%"><iframe src="https://embed.ted.com/talks/sviatlana_tsikhanouskaya_how_to_be_fearless_in_the_face_of_authoritarianism" width="854" height="480" style="position:absolute;left:0;top:0;width:100%;height:100%" frameborder="0" scrolling="no" allowfullscreen></iframe></div></div>

<h2 id="Transcript"><a href="#Transcript" class="headerlink" title="Transcript"></a>Transcript</h2><p>On August 12, 2020, two groups of girls went out to protest in <strong>Minsk</strong>, the capital city of <strong>Belarus</strong>. They put on white clothes and went barefoot out into the street. In the morning, some went to Komarovskiy Market in the center of town. Later that day, the other group gathered with flowers at the eternal flame under the victory monument. They stood together holding hands, and they started to sing <strong>the Belarusian lullaby</strong>, waiting for the police cars to arrive. They knew the police would pick them up just like that: barefoot with flowers in their hands, that they would take them to the police station, beat them up and try to humiliate them. And yet they did it anyway. </p>
<p>This year, something changed in Belarus, a country of more than nine million people that has been ruled by an <strong>authoritarian</strong> leader since 1994. These young women were protesting the latest <strong>rigged</strong> election result, which had taken [place] just a few days earlier. Their small expressions of protest very quickly expanded into massive, peaceful, women-led demonstrations all across the country. </p>
<p>Within just a few days, a few hundred thousand people took to the streets and demonstrations have continued ever since, <strong>the likes of which</strong> Belarus has never seen before. All this despite the fact that the president proclaimed himself reelected and that more than 10,000 people have been detained, hundreds tortured and at least six killed. </p>
<p>Many people wonder why the people of Belarus are speaking up now. What makes them keep <strong>taking to</strong> the streets despite unprecedented police violence, despite state lawlessness? The answer I hear the most is that people have become fearless, and it’s something we have become together. </p>
<p>Because fear is the <strong>province</strong> of one. It feeds on isolation. It doesn’t discriminate: men, women, children, elderly – all of us can feel fear, but only as long as we are on our own. Fearlessness takes two. It only works if and when we show up for each other. Show up so that your neighbor, your colleague, your friend has courage. And they will do the same for you. </p>
<p>A lot has been made of my own role in the presidential election of August 2020. How I stepped in to run for my husband, Sergei, when he was jailed and it became clear that the authorities would deny him his chance to run himself; how I rightfully won the election and became the elected leader of a democratic Belarus, but the official results only gave me 10 percent of the vote and I was forced into <strong>exile</strong> with my children; how I still fight for those who voted for me and whose voice the <strong>regime</strong> wants to steal; how “fearless” I am. </p>
<p>But there were many moments when I was frightened, and I wanted to step down. I was threatened and forced to believe that I’m alone in this fight. And yet the more cities I visited, the more people showed up for the rallies, the less fear I had. And then in the days before the election in Minsk, 60,000 people came to show their support for me, and I was no longer afraid. </p>
<p>I never wanted to do any of this. I was never overly political, and I never planned to run for office. I wanted to be a mom and a wife. But by fate and the will of my people, I was elevated to this position. And I accept this with a sense of duty and pride. I will not give up. And I will show up for people, because they show up for me. Our courage is born from unity. Our <strong>solidarity</strong> is our strength. </p>
<p>I also now understand that being fearless is a commitment. It is a decision you make every single day. It is a responsibility you take – responsibility for one another. In this regard, I’m no different from my fellow Belarusians. Their support is tangible. Their solidarity grows in <strong>progression</strong>. When there are two of you, you are <strong>daring</strong>. When you’re 100, you are brave. When there are thousands of you, you are fearless. And once you are tens of thousands, you become <strong>invincible</strong>. </p>
<p>Thank you. </p>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><blockquote>
<p><a href="https://en.wikipedia.org/wiki/2020_Belarusian_presidential_election">2020 Belarusian presidential election</a></p>
</blockquote>
<h2 id="Notes"><a href="#Notes" class="headerlink" title="Notes"></a>Notes</h2><ul>
<li><p><strong>Belarus</strong></p>
<p>白俄罗斯, Minsk is the capital city of Belarus</p>
</li>
<li><p><strong>authoritarian</strong></p>
<p>adj. 权力主义的,专制的; n. 权力主义者,专制者,独裁者</p>
</li>
<li><p><strong>rigged</strong></p>
<p>adj. 作弊的，以不正当手段操纵的</p>
<p><em>But his rival Martin Fayulu claims the vote was rigged.</em><br><em>但他的竞争对手马丁·法尤卢（Martin Fayulu）称投票存在舞弊行为。</em></p>
<p><em>The rigged polls appeared before the Trump presidential bid began.</em><br><em>该事件发生在特朗普开始竞选总统之前。</em></p>
</li>
<li><p><strong>the likes of which</strong> </p>
<p>诸如此类的事</p>
<p><em>Shapes and colors the likes of which I’ve never seen.</em><br><em>哇噻 都是我从没见过的色彩和图案。</em></p>
<p><em>Companies are moving back, creating job growth the likes of which our country has not seen in a very long time.</em><br><em>企业正在搬回，创造就业增长，这是美国很久未曾见过的。</em></p>
</li>
<li><p><strong>take to</strong></p>
<p>开始，从事，喜欢，形成…的习惯，容易学会</p>
<p><em>This week, they took to the streets.</em></p>
<p><em>本周, 他们终于走上街头。</em></p>
</li>
<li><p><strong>province</strong></p>
<p>the proper sphere or extent of your activities</p>
<p>If you say that a subject or activity is a particular person’s province, you mean that this person has a special interest in it, a special knowledge of it, or a special responsibility for it. (学识或活动的) 领域; (兴趣或职责的) 范围<br><em>Tattooing is not just the province of sailors.</em><br><em>纹身不只是水手们才感兴趣的事。</em></p>
<p><em>“it was his province to take care of himself”</em></p>
</li>
<li><p><strong>exile</strong></p>
<p>vt. 流放, 放逐, 使流亡; n. 流放, 放逐, 流亡</p>
</li>
<li><p><strong>regime</strong> </p>
<p>n. 政权，政体；社会制度；管理体制</p>
<p>政权（英语：Regime）在政府、政治和外交领域是指国家的政体的统治体制，或者特定的行政管理当局；在社会学范畴是指社会的制度，或社会的秩序。</p>
<p><em>It is an attempt by the American government to change the regime or the regime change.</em></p>
<p><em>这是美国政府在企图改变南苏丹的政权。</em></p>
</li>
<li><p><strong>solidarity</strong> </p>
<p>n. 团结</p>
</li>
<li><p><strong>progression</strong></p>
<p>n. 前进；连续</p>
<p><em>But all this quick progression has come at a cost.</em><br><em>但所有这些快速发展都是有代价的。</em></p>
<p><em>You know much about the progression of A.L.S.?</em><br><em>知道肌萎缩性脊髓侧索硬化症吗？</em></p>
<p><em>Let’s go on now to talk about chord progression.</em><br><em>接下来我们谈一下和弦进行。</em></p>
</li>
<li><p><strong>daring</strong></p>
<p>adj. 勇敢的, 无畏的</p>
</li>
<li><p><strong>invincible</strong></p>
<p>adj. 不可战胜的;不能征服的</p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ciel</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
